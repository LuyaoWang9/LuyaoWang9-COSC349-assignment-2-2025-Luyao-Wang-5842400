<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Owner Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    .hero {
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .card {
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 6px 20px rgba(0,0,0,.05);
    }
    .amount { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="/">üìä Owner Dashboard</a>
      <div class="ms-auto d-flex gap-2">
        <a class="btn btn-outline-secondary" href="/health" target="_blank">Health</a>
      </div>
    </div>
  </nav>

  <header class="hero">
    <div class="container py-5">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <h1 class="display-6 fw-bold mb-2">Who owes what</h1>
          <p class="lead text-secondary mb-0">Totals by flatmate across all recorded bills.</p>
        </div>
        <div class="d-flex gap-2">
          <button id="refresh" class="btn btn-primary">Refresh</button>
          <div class="form-check form-switch align-self-center">
            <input class="form-check-input" type="checkbox" id="autoRefreshSwitch" checked>
            <label class="form-check-label" for="autoRefreshSwitch">Auto-refresh</label>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container py-4">
    <!-- Chart card -->
    <div class="card mb-4">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span>Totals (Chart)</span>
        <small class="text-secondary" id="lastUpdatedChart">Last updated: ‚Äî</small>
      </div>
      <div class="card-body">
        <canvas id="totalsChart" height="120"></canvas>
        <p class="text-secondary small mt-3 mb-0">Data source: <code>/summary</code></p>
      </div>
    </div>

    <!-- Table card (now dynamically updated) -->
    <div class="card">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span>Totals (Table)</span>
        <small class="text-secondary" id="lastUpdatedTable">Last updated: ‚Äî</small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th style="width:180px">Total</th>
              </tr>
            </thead>
            <tbody id="totalsBody">
              <!-- Will be populated by JS -->
              <tr><td colspan="2" class="text-muted p-3">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-5">
    <div class="container">
      <div class="d-flex justify-content-between text-secondary small">
        <span>Rendered with Chart.js</span>
        <span><a class="text-decoration-none" href="/" onclick="history.back(); return false;">‚Üê Back</a></span>
      </div>
    </div>
  </footer>

  <script>
    const ctx = document.getElementById('totalsChart').getContext('2d');
    const tbody = document.getElementById('totalsBody');
    const refreshBtn = document.getElementById('refresh');
    const autoSwitch = document.getElementById('autoRefreshSwitch');
    const lastUpdatedChart = document.getElementById('lastUpdatedChart');
    const lastUpdatedTable = document.getElementById('lastUpdatedTable');

    let chart, timer;

    function setUpdated(el) {
      const now = new Date();
      el.textContent = 'Last updated: ' + now.toLocaleTimeString();
    }

    function renderTable(summary) {
      if (!summary.length) {
        tbody.innerHTML = '<tr><td colspan="2" class="text-muted p-3">No data yet</td></tr>';
        return;
      }
      tbody.innerHTML = summary.map(({name, total}) => `
        <tr>
          <td class="fw-semibold">${name}</td>
          <td class="amount">$${Number(total).toFixed(2)}</td>
        </tr>
      `).join('');
      setUpdated(lastUpdatedTable);
    }

    function renderChart(labels, values) {
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'Total ($)', data: values }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, tooltip: { enabled: true } },
          scales: { y: { beginAtZero: true } }
        }
      });
      setUpdated(lastUpdatedChart);
    }

    async function loadData() {
      try {
        const res = await fetch('/summary', { cache: 'no-store' });
        const { summary } = await res.json();

        // Sort (desc) for consistent display
        summary.sort((a, b) => b.total - a.total);

        // Update chart
        const labels = summary.map(s => s.name);
        const values = summary.map(s => s.total);
        renderChart(labels, values);

        // Update table
        renderTable(summary);
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="2" class="text-danger p-3">Failed to load data</td></tr>`;
        console.error(e);
      }
    }

    function startAuto() {
      stopAuto();
      timer = setInterval(loadData, 30000); // 30s
    }
    function stopAuto() { if (timer) clearInterval(timer); }

    refreshBtn.addEventListener('click', loadData);
    autoSwitch.addEventListener('change', () => autoSwitch.checked ? startAuto() : stopAuto());

    // Initial load + auto-refresh
    loadData();
    startAuto();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>